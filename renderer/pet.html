<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¡Œé¢å® ç‰©</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      overflow: hidden;
      background: transparent;
      width: 100vw;
      height: 100vh;
      /* æ•´ä¸ªçª—å£å¯ä»¥æ‹–æ‹½ */
      -webkit-app-region: drag;
      cursor: move; /* æ˜¾ç¤ºç§»åŠ¨å…‰æ ‡ */
    }

    #pet-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* æ‹–æ‹½åŒºåŸŸ - æ•´ä¸ªå®¹å™¨å¯æ‹–æ‹½ */
    #drag-area {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
      /* ä¸éœ€è¦è®¾ç½® cursorï¼Œç»§æ‰¿ body çš„ */
    }

    #pet-image {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
      border: 4px solid #FF9800;
      /* æŸ´çŠ¬å¯ä»¥æ‹–æ‹½ï¼ŒåŒæ—¶æ”¯æŒåŒå‡» */
      -webkit-app-region: drag;
      cursor: move;
      position: relative;
      overflow: hidden;
      z-index: 1;
      user-select: none;
      /* åŠ¨æ€åŠ¨ç”» */
      animation: float 3s ease-in-out infinite, breathe 2s ease-in-out infinite;
    }
    
    /* æ‚¬åœæç¤º */
    #pet-image:hover {
      transform: scale(1.05);
    }
    
    /* æŸ´çŠ¬ä¸“å±æ ·å¼ */
    #pet-image.shiba-mode {
      background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
      border-color: #FF9800;
      box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
    }
    
    /* è¶´ç€çš„æ ·å¼ï¼ˆå¯é€‰ï¼‰ */
    #pet-image.lying-down {
      width: 160px;
      height: 110px;
      border-radius: 25px;
    }

    /* æµ®åŠ¨åŠ¨ç”» */
    @keyframes float {
      0%, 100% {
        transform: translateY(0px) rotate(0deg);
      }
      25% {
        transform: translateY(-10px) rotate(2deg);
      }
      50% {
        transform: translateY(-5px) rotate(-2deg);
      }
      75% {
        transform: translateY(-12px) rotate(1deg);
      }
    }

    /* å‘¼å¸å…‰æ™•åŠ¨ç”» - æŸ´çŠ¬æ©™è‰²ç‰ˆæœ¬ */
    @keyframes breathe {
      0%, 100% {
        box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4),
                    0 0 0 0 rgba(255, 152, 0, 0.4);
      }
      50% {
        box-shadow: 0 12px 30px rgba(255, 152, 0, 0.6),
                    0 0 20px 10px rgba(255, 152, 0, 0.2);
      }
    }
    
    /* å¯é€‰ï¼šæ·»åŠ çˆªå°è£…é¥° */
    #pet-container::after {
      content: 'ğŸ¾';
      position: absolute;
      bottom: -5px;
      right: -5px;
      font-size: 24px;
      opacity: 0.4;
      z-index: 0;
      pointer-events: none;
      animation: pawFade 3s ease infinite;
    }
    
    @keyframes pawFade {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.5; }
    }

    #pet-image:hover {
      animation: float 3s ease-in-out infinite, breathe 2s ease-in-out infinite, pulse 0.5s ease;
    }

    /* ç‚¹å‡»è„‰å†²åŠ¨ç”» */
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.15);
      }
      100% {
        transform: scale(1);
      }
    }

    /* çœ¨çœ¼åŠ¨ç”»ï¼ˆé’ˆå¯¹ Emojiï¼‰ */
    #pet-emoji {
      animation: blink 4s infinite;
    }

    @keyframes blink {
      0%, 90%, 100% {
        opacity: 1;
      }
      95% {
        opacity: 0.1;
      }
    }

    #pet-image.has-custom-image {
      background: transparent;
    }

    #pet-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    #pet-image.has-custom-image img {
      display: block;
    }

    #pet-image.has-custom-image #pet-emoji {
      display: none;
    }

    /* åŒå‡»æ£€æµ‹å±‚ */
    #dblclick-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      /* å…è®¸äº‹ä»¶ç©¿é€ï¼Œä½†ç›‘å¬åŒå‡» */
      -webkit-app-region: no-drag;
      pointer-events: auto;
      cursor: move;
    }

    /* æ‹–æ‹½æç¤º */
    #pet-image.drag-over {
      transform: scale(1.15);
      box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
      border: 3px dashed #fff;
    }

    #pet-image.drag-over::after {
      content: 'æ”¾å¼€å›¾ç‰‡';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    /* å³é”®èœå• */
    #context-menu {
      display: none;
      position: fixed;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 150px;
      max-width: 180px;
      -webkit-app-region: no-drag;
      /* ç¡®ä¿èœå•ä¸ä¼šè¶…å‡ºçª—å£ */
      overflow: visible;
    }

    #context-menu.show {
      display: block;
    }

    .menu-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    .menu-item:hover {
      background: #f5f5f5;
    }

    .menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .menu-divider {
      height: 1px;
      background: #eee;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="pet-container">
    <!-- æ‹–æ‹½åŒºåŸŸï¼ˆæ•´ä¸ªçª—å£å¯æ‹–æ‹½ï¼‰ -->
    <div id="drag-area"></div>
    
    <!-- å® ç‰©ä¸»ä½“ -->
    <div id="pet-image" title="åŒå‡»æ‰“å¼€å¯¹è¯">
      <span id="pet-emoji">ğŸ¤–</span>
      <img id="custom-pet-image" alt="å® ç‰©">
      <!-- åŒå‡»æ£€æµ‹å±‚ -->
      <div id="dblclick-layer"></div>
    </div>
  </div>

  <!-- å³é”®èœå• -->
  <div id="context-menu">
    <div class="menu-item" id="menu-chat">ğŸ’¬ æ‰“å¼€å¯¹è¯</div>
    <div class="menu-item" id="menu-settings">âš™ï¸ è®¾ç½®</div>
    <div class="menu-divider"></div>
    <div class="menu-item" id="menu-quit">âŒ é€€å‡º</div>
  </div>

  <script>
    const petImage = document.getElementById('pet-image');
    const customImage = document.getElementById('custom-pet-image');
    const contextMenu = document.getElementById('context-menu');

    // åŠ è½½ä¿å­˜çš„å® ç‰©å›¾ç‰‡
    async function loadSavedPetImage() {
      const imagePath = await window.electronAPI.storeGet('petImagePath');
      if (imagePath) {
        customImage.src = imagePath;
        petImage.classList.add('has-custom-image');
      } else {
        // é»˜è®¤ä½¿ç”¨æŸ´çŠ¬å›¾ç‰‡
        customImage.src = '../assets/shiba.jpg';
        petImage.classList.add('has-custom-image');
      }
    }

    // åŒå‡»æ£€æµ‹å±‚
    const dblclickLayer = document.getElementById('dblclick-layer');
    
    // åŒå‡»æ‰“å¼€å¯¹è¯çª—å£
    dblclickLayer.addEventListener('dblclick', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('åŒå‡»æ£€æµ‹åˆ°ï¼');
      
      // æ·»åŠ åŒå‡»åŠ¨ç”»
      petImage.style.animation = 'pulse 0.5s ease';
      setTimeout(() => {
        petImage.style.animation = 'float 3s ease-in-out infinite, breathe 2s ease-in-out infinite';
      }, 500);
      
      // æ‰“å¼€AIå¯¹è¯çª—å£
      window.electronAPI.openChat();
    });

    // å³é”®ç‚¹å‡»ï¼šæ˜¾ç¤ºèœå•
    petImage.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // è®¡ç®—èœå•ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºçª—å£
      let menuX = e.clientX;
      let menuY = e.clientY;
      
      // èœå•å¤§å°çº¦ä¸º 150x80
      const menuWidth = 150;
      const menuHeight = 80;
      
      // å¦‚æœå³ä¾§ç©ºé—´ä¸å¤Ÿï¼Œå‘å·¦æ˜¾ç¤º
      if (menuX + menuWidth > window.innerWidth) {
        menuX = Math.max(5, window.innerWidth - menuWidth - 5);
      }
      
      // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œå‘ä¸Šæ˜¾ç¤º
      if (menuY + menuHeight > window.innerHeight) {
        menuY = Math.max(5, window.innerHeight - menuHeight - 5);
      }
      
      contextMenu.style.left = menuX + 'px';
      contextMenu.style.top = menuY + 'px';
      contextMenu.classList.add('show');
    });

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
    document.addEventListener('click', () => {
      contextMenu.classList.remove('show');
    });

    // èœå•é¡¹ç‚¹å‡»
    document.getElementById('menu-chat').addEventListener('click', () => {
      window.electronAPI.openChat();
    });

    document.getElementById('menu-settings').addEventListener('click', () => {
      window.electronAPI.openSettings();
    });

    document.getElementById('menu-quit').addEventListener('click', () => {
      window.electronAPI.quitApp();
    });

    // æ‹–æ‹½å›¾ç‰‡åŠŸèƒ½ - ç¦æ­¢é»˜è®¤æ‹–æ‹½ï¼Œåªå…è®¸æ–‡ä»¶æ‹–æ‹½
    document.addEventListener('dragstart', (e) => {
      // é˜»æ­¢é¡µé¢æ‹–æ‹½
      e.preventDefault();
    });

    petImage.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      // åªåœ¨æ‹–æ‹½æ–‡ä»¶æ—¶æ˜¾ç¤ºæç¤º
      if (e.dataTransfer.types.includes('Files')) {
        petImage.classList.add('drag-over');
      }
    });

    petImage.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      petImage.classList.remove('drag-over');
    });

    petImage.addEventListener('drop', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      petImage.classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files && files.length > 0) {
        const file = files[0];
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡æ–‡ä»¶
        if (file.type.startsWith('image/')) {
          const imagePath = file.path;
          
          // ä¿å­˜å›¾ç‰‡è·¯å¾„
          await window.electronAPI.storeSet('petImagePath', imagePath);
          
          // æ˜¾ç¤ºå›¾ç‰‡
          customImage.src = imagePath;
          petImage.classList.add('has-custom-image');
          
          console.log('å® ç‰©å›¾ç‰‡å·²æ›´æ–°:', imagePath);
        } else {
          alert('è¯·æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶ï¼ˆPNGã€JPGã€GIFç­‰ï¼‰');
        }
      }
    });

    // ç›‘å¬å® ç‰©å›¾ç‰‡æ›´æ–°ï¼ˆæ¥è‡ªè®¾ç½®é¡µé¢ï¼‰
    window.electronAPI.onPetImageUpdated((imagePath) => {
      if (imagePath) {
        customImage.src = imagePath;
        petImage.classList.add('has-custom-image');
      } else {
        // é‡ç½®ä¸ºé»˜è®¤æŸ´çŠ¬
        customImage.src = '../assets/shiba.jpg';
        petImage.classList.add('has-custom-image');
      }
      console.log('æ”¶åˆ°å›¾ç‰‡æ›´æ–°:', imagePath || 'é»˜è®¤æŸ´çŠ¬');
    });
    
    // ç›‘å¬å® ç‰©å¤§å°æ›´æ–°ï¼ˆæ¥è‡ªè®¾ç½®é¡µé¢ï¼‰
    window.electronAPI.onPetSizeUpdated((imageSize) => {
      petImage.style.width = imageSize + 'px';
      petImage.style.height = imageSize + 'px';
      console.log('æ”¶åˆ°å¤§å°æ›´æ–°:', imageSize);
    });
    
    // åŠ è½½ä¿å­˜çš„å® ç‰©å¤§å°
    async function loadSavedPetSize() {
      const size = await window.electronAPI.storeGet('petSize') || 'medium';
      const sizes = { small: 150, medium: 200, large: 250 };
      const imageSize = sizes[size] || 200;
      petImage.style.width = imageSize + 'px';
      petImage.style.height = imageSize + 'px';
    }

    // åˆå§‹åŒ–ï¼šåŠ è½½ä¿å­˜çš„å›¾ç‰‡å’Œå¤§å°
    loadSavedPetImage();
    loadSavedPetSize();
  </script>
</body>
</html>
